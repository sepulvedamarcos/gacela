' Gambas class file

'
'
' Clase de acceso a datos en BD
'
'
Private $log4Gambas As Log4Gambas3
Private $dbContext As SQLiteContext
Private $configuration As Configuration

Property Read DBContext As SQLiteContext

' ==================================================
'
'          Metodos publicos
'
' ==================================================
Public Sub _new(configuration As Configuration, logger As Log4Gambas3, context As SQLiteContext)

  $log4Gambas = logger
  $dbContext = context
  $configuration = configuration

End

Public Function getPhotos(Optional id As Integer) As PhotoEntity[]

  Dim photo As PhotoEntity
  Dim photos As PhotoEntity[]
  Dim photoResult As Result
  Dim query As String

  $log4Gambas.Debug("Extraccion de fotos")

  query = "soft_delete = &1"
  If id > 0 Then
    query = "AND id = " & id
  End If

  photoResult = $dbContext.DBConnection.Find(Constants.TABLE_PHOTOS, query, False)

  If photoResult.Available Then
    $log4Gambas.Debug("Extraccion de " & photoResult.Count & " fotos de la respuesta")

    Return MapResultToEntities(photoResult)

  Endif

Catch
  $log4Gambas.Error("Problemas para recuperar las fotos " & Error.Text)
  Error.Propagate

End

Public Function createPhoto(photo As PhotoEntity) As PhotoEntity

  Dim result As Result

  result = $dbContext.DBConnection.Create(Constants.TABLE_PHOTOS)
  result["id"] = $dbContext.CreateKey()
  result["file_name"] = photo.FileName
  result["original_photo"] = photo.OriginalPhoto
  result["thumbnail"] = photo.Thumbnail
  result["width_pixels"] = photo.WidthPixels
  result["height_pixels"] = photo.HeightPixels
  result["creation_date"] = Now()
  result["last_sync_date"] = Now()
  result["import_date"] = Now()
  result["import_user"] = User.Name
  result["soft_delete"] = False
  result.Update()

End

' ==================================================
'
'          Metodos privados
'
' ==================================================

Private Function MapResultToEntities(result As Result) As PhotoEntity[] '' Mapeo privado dentro del Repository

  Dim photo As PhotoEntity
  Dim photos As New PhotoEntity[]

  For Each Result
    photo = New PhotoEntity

    ' Mapear todos los campos
    photo.Id = result["id"]
    photo.FileName = result["file_name"]
    photo.WidthPixels = IIf(result["width_pixels"] <> Null, result["width_pixels"], 0)
    photo.HeightPixels = IIf(result["height_pixels"] <> Null, result["height_pixels"], 0)
    photo.CreationDate = result["creation_date"]
    photo.ImportDate = result["import_date"]
    photo.Description = result["description"]
    photo.ImportUser = result["import_user"]
    photo.OriginalPhoto = result["original_photo"]
    photo.Thumbnail = result["thumbnail"]
    photo.LastSyncDate = result["last_sync_date"]
    photo.SoftDelete = result["soft_delete"]

    photos.Add(photo)

  Next

  Return photos

Catch
  Error.Propagate

End

Private Sub MapEntityToResult(photo As PhotoEntity, result As Result) '' Mapeo privado Entity â†’ Result

  result["file_name"] = photo.FileName
  result["md5_hash"] = photo.MD5Hash
  result["original_size"] = photo.OriginalSize
  result["compressed_size"] = photo.CompressedSize
  result["width_pixels"] = photo.WidthPixels
  result["height_pixels"] = photo.HeightPixels
  result["original_format"] = photo.OriginalFormat
  result["creation_date"] = photo.CreationDate
  result["import_date"] = photo.ImportDate
  result["description"] = photo.Description
  result["is_favorite"] = photo.IsFavorite
  result["import_user"] = photo.ImportUser
  result["soft_delete"] = Not photo.SoftDelete
  result["compressed_photo"] = photo.CompressedPhoto
  result["thumbnail"] = photo.Thumbnail
  result["compression_level"] = photo.CompressionLevel
  result["last_sync_date"] = photo.LastSyncDate

End

Private Function DBContext_Read() As SQLiteContext

  Return $dbContext

End
