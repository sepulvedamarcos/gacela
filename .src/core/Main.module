' Gambas module file

' Modulo de inicio de la aplicación Gestor de Álbumes Compartidos en Linux Avanzado

' Constantes de la aplicación
Private Const DIRECTORIO_GACELA As String = ".config/gacela"
Private Const BIBLIOTECA_COMPARTIDA As String = "/usr/share/gacela/biblioteca"
Private Const GRUPO_GACELA As String = "gacela-users"

' Clases para inyección de dependencias (patrón DI manual)
Private $configuration As Configuration
Private $log4Gambas As Log4Gambas3
Private $connDB As SQLiteContext
Private $photorepository As PhotoRepository
Private $photoService As PhotoService
Private $compressionService As CompressionService

Public Sub Main()

  Dim response As Integer
  Dim formMain As FMain
  Dim result As String

  $configuration = New Configuration
  $log4Gambas = $configuration.InitializeLogger()

  If $configuration.IsFirstRun Then
    ' lanzamos ventana de advertencia para que seleccione como desea iniciar la aplicación
    response = Message.Warning(("Hemos detectado que la primera vez que ejecuta la aplicación. Debe seleccionar cual de es la configuración con la que desea iniciar. Siempre la puede cambiar en el apartado de configuraciones"), ("Biblioteca privada"), ("Multiusuario"), ("Cancelar"))

    Select Case response
      Case $configuration.LibraryType_Private
        $log4Gambas.Debug("Seleccion de biblioteca privada")
        ' Le indicamos a la clase configuration que cargue ambiente privado
        $configuration.InitializePrivateSettings()

      Case $configuration.LibraryType_Shared
        $log4Gambas.Debug("Seleccion de biblioteca multiusuario")
        ' Le indicamos a la clase configuration que cargue ambiente multiusuario
        $configuration.InitializeMultiUserSettings()

      Case Else
        Stop
    End Select

  Else
    ' Cargamos el ambiente configurado
    $configuration.InitializeEnvironment()
  Endif

  $log4Gambas.Info("Iniciando Gacela v" & Application.Version)

  ' Inicializacion e inyectores
  $connDB = New SQLiteContext($configuration, $log4gambas)
  $photorepository = New PhotoRepository($configuration, $log4Gambas, $connDB)
  $compressionService = New CompressionService($configuration, $log4gambas)
  $photoService = New PhotoService($configuration, $log4gambas, $photorepository, $compressionService)

  ' creamos e inyectamos en el formulario
  formMain = New FMain($configuration, $log4gambas, $photoService)
  formMain.Show()

Catch
  Print "Se detecto un problema grave y se detendra la aplicación" & Error.Text

End
